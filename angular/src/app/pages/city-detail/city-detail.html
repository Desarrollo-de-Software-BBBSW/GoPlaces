<div class="container mt-5">

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <div *ngIf="!isLoading && errorMessage" class="alert alert-danger shadow-sm">
    <i class="fa fa-exclamation-circle me-2"></i> {{ errorMessage }}
    <div class="mt-2">
      <a routerLink="/cities" class="btn btn-sm btn-outline-danger">Volver al listado</a>
    </div>
  </div>

  <div *ngIf="!isLoading && city" class="card shadow border-0 mx-auto" style="max-width: 600px;">
    
    <div class="card-header bg-info text-white text-center py-5" 
         style="background: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%);">
      <h1 class="display-4 fw-bold mb-0"><i class="fa fa-building"></i></h1>
    </div>

    <div class="card-body p-4 text-center">
      <h2 class="card-title fw-bold mb-1">{{ city.name }}</h2>
      <p class="text-muted fs-5 mb-3">
        <i class="fa fa-map-marker-alt me-1 text-danger"></i> {{ city.country }}
      </p>

      <div class="d-flex flex-column align-items-center mb-4">
        <span class="text-muted small text-uppercase fw-bold mb-2 letter-spacing-1">Calificación promedio</span>
        <div class="bg-warning text-dark rounded-pill px-4 py-2 fs-5 fw-bold shadow-sm d-inline-flex align-items-center">
          <i class="fa fa-star me-2"></i> 
          <span *ngIf="averageRating > 0">{{ averageRating }} <span class="text-dark fs-6 opacity-75 fw-normal ms-1">/ 5</span></span>
          <span *ngIf="averageRating === 0" class="fs-6 fw-normal">Sin calificaciones</span>
        </div>
      </div>

      <hr class="my-4">
      
      <div class="rating-section mb-4">
        
        <div *ngIf="!isAuthenticated" class="alert alert-light border">
          <small><i class="fa fa-lock me-1"></i> <a routerLink="/account/login">Inicia sesión</a> para calificar.</small>
        </div>

        <div *ngIf="(isAuthenticated && !userRating) || isEditing">
          <h5 class="mb-3">{{ isEditing ? 'Edita tu calificación' : '¿Qué te pareció este lugar?' }}</h5>
          
          <div class="mb-3 fs-2 text-warning" style="cursor: pointer;">
            <i *ngFor="let star of [1,2,3,4,5]"
               class="fa"
               [ngClass]="(hoverScore >= star || selectedScore >= star) ? 'fa-star' : 'fa-star-o'"
               (mouseenter)="hoverScore = star"
               (mouseleave)="hoverScore = 0"
               (click)="selectedScore = star">
            </i>
          </div>

          <div class="mb-3" *ngIf="selectedScore > 0">
            <textarea [(ngModel)]="ratingComment" class="form-control" rows="2" placeholder="Escribe un comentario (opcional)..."></textarea>
          </div>

          <div>
            <button class="btn btn-primary me-2" 
                    [disabled]="selectedScore === 0 || isRatingSubmitting"
                    (click)="submitRating()">
              <span *ngIf="isRatingSubmitting" class="spinner-border spinner-border-sm me-1"></span>
              {{ isEditing ? 'Actualizar' : 'Enviar' }} Calificación
            </button>
            <button *ngIf="isEditing" class="btn btn-outline-secondary" (click)="cancelEdit()">
              Cancelar
            </button>
          </div>
        </div>

        <div *ngIf="userRating && !isEditing" class="bg-light p-3 rounded border border-success position-relative">
          <div class="text-success fw-bold mb-1">
            <i class="fa fa-check-circle me-1"></i> ¡Ya calificaste este destino!
          </div>
          <div class="text-warning fs-4 mb-2">
            <i *ngFor="let star of [1,2,3,4,5]" 
               class="fa" 
               [ngClass]="userRating.score >= star ? 'fa-star' : 'fa-star-o'">
            </i>
          </div>
          <p *ngIf="userRating.comment" class="text-muted mt-2 fst-italic">
            "{{ userRating.comment }}"
          </p>
          
          <div class="mt-3">
            <button class="btn btn-sm btn-outline-primary me-2" (click)="enableEdit()">
              <i class="fa fa-pencil-alt"></i> Editar
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="deleteRating()">
              <i class="fa fa-trash"></i> Eliminar
            </button>
          </div>
        </div>

      </div>
      
<hr class="my-5">
      <div class="comments-section text-start mb-4">
        <h4 class="fw-bold mb-4 text-secondary">
          <i class="fa fa-comments-o me-2 text-primary"></i> Opiniones de los viajeros
        </h4>

        <div *ngIf="comments.length === 0" class="text-center text-muted p-4 bg-light rounded border border-dashed">
          <i class="fa fa-info-circle fs-3 mb-2 opacity-50"></i>
          <p class="mb-0">Aún no hay opiniones sobre este destino. ¡Sé el primero en contar tu experiencia!</p>
        </div>

        <div class="row">
          <div *ngFor="let item of comments" class="col-12 mb-3">
            <div class="card border-0 shadow-sm" style="background-color: #f8f9fa;">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="card-subtitle fw-bold text-dark mb-0">
                    <i class="fa fa-user-circle text-primary me-1"></i> {{ item.userName || 'Viajero Anónimo' }}
                  </h6>
                  <small class="text-muted" *ngIf="item.creationTime">
                    {{ item.creationTime | date:'shortDate' }}
                  </small>
                </div>
                
                <div class="text-warning mb-2" style="font-size: 0.9rem;">
                  <i *ngFor="let star of [1,2,3,4,5]" class="fa" 
                     [ngClass]="item.score >= star ? 'fa-star' : 'fa-star-o'"></i>
                </div>
                
                <p class="card-text text-secondary mb-0" *ngIf="item.comment">
                  "{{ item.comment }}"
                </p>
                <p class="card-text text-muted mb-0 fst-italic" *ngIf="!item.comment">
                  <small>Dejó una calificación sin comentario.</small>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
        <button routerLink="/" class="btn btn-outline-secondary px-4">
          <i class="fa fa-arrow-left me-2"></i> Volver
        </button>
      </div>
    </div>
    
    <div class="card-footer bg-light text-muted text-center py-2 small">
      GeoDB ID: {{ city.id }}
    </div>
  </div>
</div>